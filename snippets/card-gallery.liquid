{% doc %}
  Displays product images in a carousel.
  Settings allow for a full slideshow, showing only the first image, or showing the second image when hovering.
  Note: When the product card itself is in a carousel layout, the card-gallery's carousel is disabled with JavaScript.

  @param [children] – Additional content rendered below the card gallery
  @param [section]  – The section object the snippet is rendered in
  @param [block]    – The block object the snippet is rendered in
{% enddoc %}

{% liquid
  assign product              = block.settings.product
  assign card_image_metafield = product.metafields.custom.product_card_image
  assign metafield_present    = card_image_metafield != blank
  assign image_sizes          = '(min-width: 750px) 50vw, 100vw'
%}

{%- comment -%} ---------- size helpers (unchanged) ---------- {%- endcomment -%}
{% if section.settings.product_card_size %}
  {% capture card_size %}
    {% render 'util-product-grid-card-size', section: section %}
  {% endcapture %}
  {% assign card_size = card_size | strip | replace: 'px', '' | plus: 0 %}
  {% capture sizes_attribute %}
    {% render 'util-autofill-img-size-attr',
      section:   section,
      card_size: card_size,
      card_gap:  section.settings.columns_gap_horizontal %}
  {% endcapture %}
  {% assign image_sizes = sizes_attribute | strip %}
{% elsif section.settings.columns and section.settings.layout_type != 'editorial' %}
  {% assign viewport_width  = 100.0 | divided_by: section.settings.columns %}
  {% assign sizes_attribute = '(min-width: 750px) [viewport_width]vw, 100vw'
    | replace: '[viewport_width]', viewport_width %}
  {% assign image_sizes = sizes_attribute | strip %}
{% endif %}

{% stylesheet %}
  .card-gallery {
    overflow: hidden;
    container-type: inline-size;
    container-name: card-gallery-container;
  }

  .card-gallery__placeholder svg {
    height: 100%;
    width: 100%;
  }

  .card-gallery placeholder-image {
    aspect-ratio: var(--gallery-aspect-ratio, var(--ratio));
  }

  .product-card-gallery__title-placeholder {
    padding: var(--padding-md);
    font-size: var(--font-size--2xl);
    line-height: var(--line-height--display-loose);
    word-break: break-word;
    color: var(--color-foreground);
    background-color: rgb(from var(--color-foreground) r g b / 5%);
    aspect-ratio: var(--gallery-aspect-ratio);
    border-radius: var(--product-corner-radius);
    display: -webkit-box;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @media screen and (width >= 750px) {
    .product-grid[data-product-card-size='extra-large'] .product-card-gallery__title-placeholder {
      padding: var(--padding-3xl);
      font-size: var(--font-size--3xl);
    }
    .product-grid[data-product-card-size='large'] .product-card-gallery__title-placeholder {
      padding: var(--padding-2xl);
      font-size: var(--font-size--2xl);
    }
    .product-grid[data-product-card-size='medium'] .product-card-gallery__title-placeholder {
      padding: var(--padding-xl);
      font-size: var(--font-size--xl);
    }
    .product-grid[data-product-card-size='small'] .product-card-gallery__title-placeholder {
      padding: var(--padding-sm);
      font-size: var(--font-size--lg);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery:has(.product-badges--top-right .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-3xl) + 50px);
    }
    .product-grid[data-product-card-size='large']
      .card-gallery:has(.product-badges--top-right .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-2xl) + 50px);
    }
    .product-grid[data-product-card-size='medium']
      .card-gallery:has(.product-badges--top-right .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-xl) + 50px);
    }
    .product-grid[data-product-card-size='small']
      .card-gallery:has(.product-badges--top-right .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-sm) + 50px);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery:has(.product-badges--top-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-3xl) + 40px);
    }
    .product-grid[data-product-card-size='large']
      .card-gallery:has(.product-badges--top-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-2xl) + 40px);
    }
    .product-grid[data-product-card-size='medium']
      .card-gallery:has(.product-badges--top-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-xl) + 40px);
    }
    .product-grid[data-product-card-size='small']
      .card-gallery:has(.product-badges--top-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-sm) + 40px);
    }

    .product-grid[data-product-card-size='extra-large']
      .card-gallery:has(.product-badges--bottom-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-3xl) + 40px);
    }
    .product-grid[data-product-card-size='large']
      .card-gallery:has(.product-badges--bottom-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-2xl) + 40px);
    }
    .product-grid[data-product-card-size='medium']
      .card-gallery:has(.product-badges--bottom-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-xl) + 40px);
    }
    .product-grid[data-product-card-size='small']
      .card-gallery:has(.product-badges--bottom-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-sm) + 40px);
    }
  }

  @media screen and (width < 750px) {
    .product-card-gallery__title-placeholder {
      font-size: var(--font-size--xl);
      padding: var(--padding-md);
    }
    .product-grid[data-product-card-size]
      .card-gallery:has(.product-badges--top-right .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-right: calc(var(--padding-sm) + 50px);
    }
    .product-grid[data-product-card-size]
      .card-gallery:has(.product-badges--top-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-top: calc(var(--padding-sm) + 40px);
    }
    .product-grid[data-product-card-size]
      .card-gallery:has(.product-badges--bottom-left .product-badges__badge)
      .product-card-gallery__title-placeholder {
      padding-bottom: calc(var(--padding-sm) + 40px);
    }
  }

  [product-grid-view='zoom-out'] .card-gallery .product-card-gallery__title-placeholder {
    padding: var(--padding-xs) !important;
    font-size: var(--font-size--xs);
  }
{% endstylesheet %}

{% liquid
  assign lazy_image_sizes  = 'auto, ' | append: image_sizes
  assign image_ratio_setting = block.settings.image_ratio
  assign temp_ratio          = 1

  if image_ratio_setting == 'landscape'
    assign temp_ratio = '16 / 9'
  elsif image_ratio_setting == 'portrait'
    assign temp_ratio = '4 / 5'
  elsif image_ratio_setting == 'square'
    assign temp_ratio = '1'
  elsif image_ratio_setting == 'adapt'
    if metafield_present
      assign candidate_image = card_image_metafield
    else
      assign candidate_image = product.featured_image
      if candidate_image == blank and product.featured_media.preview_image != blank
        assign candidate_image = product.featured_media.preview_image
      endif
    endif
    if candidate_image != blank and candidate_image.aspect_ratio != null and candidate_image.aspect_ratio > 0
      assign temp_ratio = candidate_image.aspect_ratio
    endif
  endif

  assign ratio = temp_ratio != blank and temp_ratio != 0 and temp_ratio != '' ? temp_ratio : 1

  assign variant_images             = product.images | where: 'attached_to_variant?', true | map: 'src'
  assign selected_variant_image     = product.selected_or_first_available_variant.image.src
  assign selected_variant_image_idx = 0
  for image in product.images
    if image.src == selected_variant_image
      assign selected_variant_image_idx = forloop.index0
    endif
  endfor

  assign hover_behavior = 'carousel'

  if block.settings.image_ratio == 'adapt' and block.settings.constrain_to_viewport
    if block.settings.constrain_to_viewport != ''
      assign constrain_to_viewport = true
      assign media_fit = block.settings.constrain_to_viewport
    endif
  endif
%}

{% capture placeholder_image %}
  <placeholder-image data-block-id="{{ section.id }}-{{ block.id }}" data-type="product"></placeholder-image>
{% endcapture %}
{% capture placeholder_slide %}
  {% render 'slideshow-slide',
    index: 1,
    children: placeholder_image,
    class: 'product-media-container card-gallery__placeholder' %}
{% endcapture %}
{% capture slideshow_placeholder %}
  {% render 'slideshow',
    ref: 'slideshow',
    slides: placeholder_slide,
    slide_count: 1,
    attributes: 'disabled="true"' %}
{% endcapture %}

<div
  ref="cardGallery"
  class="
    card-gallery card-gallery-{{ block.id }} spacing-style border-style
    {% if block.settings.product == blank and request.design_mode == false %}hidden{% endif %}
  "
  style="
    {% render 'border-override', settings: block.settings %}
    {% render 'spacing-style',   settings: block.settings %}
    --gallery-aspect-ratio: {{ ratio }};
  "
  data-product-id="{{ product.id }}"
  on:pointerenter="/previewImage"
  on:pointerleave="/resetImage"
  {% if settings.transition_to_main_product %}data-view-transition-to-main-product{% endif %}
  data-image-ratio="{{ block.settings.image_ratio }}"
  {{ block.shopify_attributes }}
>
  {% assign all_media = product.media %}

  {%- comment -%} include variant featured images for combined listings (unchanged) {%- endcomment -%}
  {% for product_option in product.options_with_values %}
    {% for product_option_value in product_option.values %}
      {% if product_option_value.swatch %}
        {% assign featured_media = product_option_value.variant.featured_media %}
        {% if featured_media == blank and product_option_value.product_url %}
          {% assign featured_media = product_option_value.variant.product.featured_media %}
        {% endif %}
        {% assign existing_media = all_media | has: 'id', featured_media.id %}
        {% unless existing_media %}
          {% assign variant_featured_media = product_option_value.variant.product.media
            | where: 'id', featured_media.id %}
          {% assign all_media = all_media | concat: variant_featured_media %}
        {% endunless %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  {%- assign slide_total = all_media.size | plus: metafield_present -%}
  {%- if slide_total > 0 -%}
    {% if slide_total > 2 and hover_behavior == 'carousel' %}
      {% assign show_arrows = true %}
    {% endif %}

    {% capture slides %}
      {%- if metafield_present -%}
        {% assign loading = 'lazy' %}
        {% assign sizes   = lazy_image_sizes %}
        {% if section.index == nil or section.index < 5 %}
          {% assign loading = 'eager' %}
          {% assign sizes   = image_sizes %}
        {% endif %}

        {% capture slideshow_children %}
          {{ card_image_metafield
            | image_url: width: 1946
            | image_tag:
              widths: widths,
              alt: product.title,
              sizes: sizes,
              loading: loading,
              class: 'product-media__image' }}
        {% endcapture %}

        {% render 'slideshow-slide',
          slide_id: 'metafield',
          index: 0,
          children: slideshow_children,
          class: 'product-media-container' %}
      {%- endif -%}

      {% for media in all_media %}
        {% assign loading = 'lazy' %}
        {% assign sizes   = lazy_image_sizes %}
        {% if forloop.first and section.index == nil or section.index < 5 %}
          {% assign loading = 'eager' %}
          {% assign sizes   = image_sizes %}
        {% endif %}

        {% capture slideshow_children %}
          {% render 'product-media',
            media: media,
            sizes: sizes,
            widths: widths,
            loading: loading,
            preview_image_only: true %}
        {% endcapture %}

        {% capture class %}
          product-media-container
          media-fit
          product-media-container--{{ media.media_type }}
          {% if constrain_to_viewport %}constrain-height{% endif %}
        {% endcapture %}

        {% assign attributes = '' %}
        {% assign hidden     = false %}
        {% if variant_images contains media.src %}
          {% assign attributes = 'variant-image' %}
          {% unless forloop.first %}{% assign hidden = true %}{% endunless %}
        {% endif %}

        {% render 'slideshow-slide',
          slide_id:  media.id,
          index:     forloop.index | plus: metafield_present,
          children:  slideshow_children,
          class:     class,
          attributes: attributes,
          hidden:    hidden,
          media_fit: media_fit %}
      {% endfor %}
    {% endcapture %}

    {% assign slideshow_attributes = hover_behavior == 'none' ? 'disabled="true"' : '' %}
    {% render 'slideshow',
      ref: 'slideshow',
      initial_slide: 0,
      slides: slides,
      slide_count: slide_total,
      show_arrows: show_arrows,
      attributes: slideshow_attributes %}
  {% elsif product != blank and product.media.size == 0 %}
    <product-title class="product-card-gallery__title-placeholder">
      <span class="title-text">{{ product.title }}</span>
    </product-title>
  {% elsif product == blank %}
    {{ slideshow_placeholder }}
  {% endif %}
  {{ children }}
</div>
