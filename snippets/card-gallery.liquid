{% doc %}
  Displays product images in a carousel.
  Settings allow for a full slideshow, showing only the first image, or showing the second image when hovering.
  Note: When the product card itself is in a carousel layout, the card-gallery's carousel is disabled with JavaScript.

  @param [children] - Additional content rendered below the card gallery
  @param [section] - The section object the snippet is rendered in
  @param [block] - The block object the snippet is rendered in
{% enddoc %}

{% comment %}
调试：查看 metafield 是否非空
{% endcomment %}
{{ block.settings.product.metafields.custom.product_card_image | json }}


{% liquid
  #####  ❰❰❰ 新增 / 修改开始 ❱❱❱
  # 读取自定义 metafield 图片，优先级高于产品首图
  assign card_image_metafield = block.settings.product.metafields.custom.product_card_image
  #####  ❰❰❰ 新增 / 修改结束 ❱❱❱

  assign image_sizes = '(min-width: 750px) 50vw, 100vw'
  # …（以下原有 assign 及注释保持不变）
%}

{%- comment -%}
  =========================
  样式表、占位符等原样保留
  =========================
{%- endcomment -%}

{% stylesheet %}
  .card-gallery { overflow: hidden; container-type: inline-size; container-name: card-gallery-container; }
  /* ……（原有 CSS 全部不动，为节省篇幅省略） */
{% endstylesheet %}

{% liquid
  #####  ❰❰❰ 新增 / 修改开始 ❱❱❱
  # ↓ 原文件这里是：assign product = block.settings.product
  #   我们在它上面已经读取过 metafield，这里仍保留，方便后续引用
  assign product = block.settings.product

  # 判断 ratio 时，同样先看 metafield 图有没有值
  assign image_source_for_ratio = card_image_metafield
  if image_source_for_ratio == blank
    assign image_source_for_ratio = product.featured_image
    if image_source_for_ratio == blank and product.featured_media.preview_image != blank
      assign image_source_for_ratio = product.featured_media.preview_image
    endif
  endif
  #####  ❰❰❰ 新增 / 修改结束 ❱❱❱

  assign lazy_image_sizes = 'auto, ' | append: image_sizes
  assign image_ratio_setting = block.settings.image_ratio
  assign temp_ratio = 1

  if image_ratio_setting == 'landscape'
    assign temp_ratio = '16 / 9'
  elsif image_ratio_setting == 'portrait'
    assign temp_ratio = '4 / 5'
  elsif image_ratio_setting == 'square'
    assign temp_ratio = '1'
  elsif image_ratio_setting == 'adapt'
    if image_source_for_ratio != blank and image_source_for_ratio.aspect_ratio != null and image_source_for_ratio.aspect_ratio > 0
      assign temp_ratio = image_source_for_ratio.aspect_ratio
    endif
  endif

  if temp_ratio != blank and temp_ratio != 0 and temp_ratio != ''
    assign ratio = temp_ratio
  else
    assign ratio = 1
  endif

  # ========== 下面是媒体列表处理 ==========
  # 默认把产品所有 media 放进 all_media
  assign all_media = product.media

  #####  ❰❰❰ 新增 / 修改开始 ❱❱❱
  # 如果 metafield 图存在，就把它插到最前面，且去重
  if card_image_metafield and card_image_metafield != blank
    assign existing_metafield_media = all_media | where: 'id', card_image_metafield.id
    unless existing_metafield_media != empty
      assign all_media = card_image_metafield | concat: all_media
    endunless
  endif
  #####  ❰❰❰ 新增 / 修改结束 ❱❱❱

  # ……（variant_images、hover_behavior 等原逻辑不变）
%}

{%- comment -%}
  ======= 以下 HTML 结构、slideshow 渲染及 JS 钩子均与原文件一致 =======
{%- endcomment -%}

<div
  ref="cardGallery"
  class="
    card-gallery card-gallery-{{ block.id }} spacing-style border-style
    {% if block.settings.product == blank and request.design_mode == false %}hidden{% endif %}
  "
  style="
    {% render 'border-override', settings: block.settings %}
    {% render 'spacing-style', settings: block.settings %}
    --gallery-aspect-ratio: {{ ratio }};
  "
  data-product-id="{{ product.id }}"
  on:pointerenter="/previewImage"
  on:pointerleave="/resetImage"
  {% if settings.transition_to_main_product %}data-view-transition-to-main-product{% endif %}
  data-image-ratio="{{ block.settings.image_ratio }}"
  {{ block.shopify_attributes }}
>
  {%- comment -%}
    slides 部分保持原逻辑，会自动使用 all_media，
    因为我们已在上面把 metafield 图插进去/替换掉 featured 图
  {%- endcomment -%}

  {%- if all_media.size > 0 -%}
    {% if all_media.size > 2 and hover_behavior == 'carousel' %}
      {% assign show_arrows = true %}
    {% endif %}

    {% capture slides %}
      {% for media in all_media %}
        {% assign loading = 'lazy' %}
        {% assign sizes = lazy_image_sizes %}

        {% if forloop.first and section.index == nil or section.index < 5 %}
          {% assign loading = 'eager' %}
          {% assign sizes = image_sizes %}
        {% endif %}

        {% assign attributes = '' %}
        {% capture slideshow_children %}
          {%- render 'product-media', media: media, sizes: sizes, widths: widths, loading: loading, preview_image_only: true -%}
        {% endcapture %}
        {% capture class %}
          product-media-container media-fit product-media-container--{{ media.media_type }}{% if constrain_to_viewport %} constrain-height{% endif %}
        {% endcapture %}
        {% assign hidden = false %}
        {% if variant_images contains media.src %}
          {% assign attributes = 'variant-image' %}
          {% unless forloop.first %}{% assign hidden = true %}{% endunless %}
        {% endif %}
        {% render 'slideshow-slide', slide_id: media.id, index: forloop.index, children: slideshow_children, class: class, attributes: attributes, hidden: hidden, media_fit: media_fit %}
      {% endfor %}
    {% endcapture %}

    {% assign slideshow_attributes = '' %}
    {% if hover_behavior == 'none' %}
      {% assign slideshow_attributes = 'disabled="true"' %}
    {% endif %}
    {% render 'slideshow',
      ref: 'slideshow',
      initial_slide: 0,
      slides: slides,
      slide_count: all_media.size,
      show_arrows: show_arrows,
      attributes: slideshow_attributes
    %}
  {% elsif product != blank and product.media.size == 0 %}
    <product-title class="product-card-gallery__title-placeholder">
      <span class="title-text">{{- product.title -}}</span>
    </product-title>
  {% elsif product == blank %}
    {{ slideshow_placeholder }}
  {%- endif -%}
  {{ children }}
</div>
